plugins:
  - serverless-dotenv-plugin
  - serverless-offline

service: ${env:SERVERLESS_NAME}

provider:
  name: aws
  runtime: nodejs8.10
  stage: ${env:ENVIRONMENT}
  region: us-east-1
  versionFunctions: false
  deploymentBucket:
    name: serverless-elearning-${env:ENVIRONMENT}-deployment
  logRetentionInDays: 10
  environment:
    AWS_KEY: ${env:AWS_KEY}
    AWS_SECRET: ${env:AWS_KEY}
    AWS_ACCOUNT_ID: ${env:AWS_ACCOUNT_ID}
    AWS_REGION_CODE: ${env:AWS_REGION_CODE}
    AWS_API_VERSION: ${env:AWS_API_VERSION}

    AWS_DYNAMO_DB_READ_CAPACITY_UNITS: ${env:AWS_DYNAMO_DB_READ_CAPACITY_UNITS}
    AWS_DYNAMO_DB_WRITE_CAPACITY_UNITS: ${env:AWS_DYNAMO_DB_WRITE_CAPACITY_UNITS}
    AWS_DYNAMO_DB_LIMIT: ${env:AWS_DYNAMO_DB_LIMIT}

    ENVIRONMENT: ${env:ENVIRONMENT}

    CORS_ALLOW_ORIGIN: ${env:CORS_ALLOW_ORIGIN}

    BASE_URL: ${env:BASE_URL}
    PORT: ${env:PORT}

    SERVERLESS_NAME: ${env:SERVERLESS_NAME}

functions:
  - ${file(./src/context/v1/subscriptions/serverless.yml)}

resources:
  Resources:
    GatewayResponseDefault4XX:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,DELETE,OPTIONS'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: 'ApiGatewayRestApi'

custom:
  serverless-offline:
    port: ${self:provider.environment.PORT}
